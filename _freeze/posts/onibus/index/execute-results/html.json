{
  "hash": "3306da5e3e79be307ee3b2786a53500e",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Atividade 2 - Monitoramento de Frota de Ônibus\"\nauthor: André Bellin\ndate: \"2025-11-23\"\ncategories: [API, PYTHON, CODE]\nimage: \"onibuscmtc-gestaocovas.jpg\"\n---\n\nO objetivo desta atividade é implementar uma ferramenta visual para acompanhar em tempo real o funcionamento de uma linha de ônibus. O sistema busca, via API, tanto as paradas fixas quanto as posições atualizadas dos veículos. Com essas informações, é gerado um mapa interativo que destaca cada tipo de ponto com marcadores de cores diferentes, permitindo identificar facilmente o trajeto oficial e a movimentação atual da frota.\n\n::: {#a787ba38 .cell execution_count=1}\n``` {.python .cell-code}\n# Versão robusta: utiliza o token SPTRANS_TOKEN caso exista; se não houver, usa dados locais para demonstração.\nimport os\nimport requests\nfrom dotenv import load_dotenv\nfrom IPython.display import HTML, display\nimport folium\nimport math\n\nload_dotenv()\ntoken = os.getenv(\"SPTRANS_TOKEN\")\n\ns = requests.Session()\n\n# Conjunto de dados fictícios utilizado quando o token não estiver disponível ou a API falhar\ndemo_paradas = [\n    {\"cp\": 7014417, \"np\": \"ANGELICA B/C\", \"ed\": \"AV ANGELICA\", \"py\": -23.534564, \"px\": -46.654302},\n    {\"cp\": 60016784, \"np\": \"PARADA PALMEIRAS B/C\", \"ed\": \"R PADRE ANTONIO TOMAS\", \"py\": -23.525799, \"px\": -46.679251},\n    {\"cp\": 60016786, \"np\": \"ANTARTICA B/C\", \"ed\": \"PC SOUSA ARANHA\", \"py\": -23.526523, \"px\": -46.673588},\n    {\"cp\": 12783, \"np\": \"PARADA D\", \"ed\": \"R EXEMPLO\", \"py\": -23.535317, \"px\": -46.653005},\n]\n\ndemo_pos = [\n    {\"p\": \"12783\", \"ta\": \"2024-09-27T01:05:47Z\", \"py\": -23.53531725, \"px\": -46.653005},\n    {\"p\": \"12534\", \"ta\": \"2024-09-27T01:06:10Z\", \"py\": -23.547649, \"px\": -46.6410115},\n]\n\ndef fetch_paradas_pos(codigo_linha=2506):\n    \"\"\"\n    Obtém as paradas e posições dos veículos da linha desejada.\n    - Se o token estiver disponível e a API responder corretamente, usa dados reais.\n    - Caso contrário, retorna os dados de demonstração pré-definidos.\n    \"\"\"\n    if not token:\n        print(\"SPTRANS_TOKEN ausente — carregando dados de demonstração.\")\n        return demo_paradas, demo_pos\n\n    try:\n        # Autenticação junto à API (algumas versões usam GET ou POST; aqui mantemos POST como padrão)\n        auth = s.post(\n            f\"https://api.olhovivo.sptrans.com.br/v2.1/Login/Autenticar?token={token}\", timeout=10\n        )\n        print(\"Resposta do login:\", auth.text)\n\n        # Requisição das paradas da linha informada\n        r_par = s.get(\n            f\"https://api.olhovivo.sptrans.com.br/v2.1/Parada/BuscarParadasPorLinha?codigoLinha={codigo_linha}\",\n            timeout=10\n        )\n        paradas = r_par.json()\n\n        # Requisição da posição dos veículos\n        r_pos = s.get(\n            f\"https://api.olhovivo.sptrans.com.br/v2.1/Posicao/Linha?codigoLinha={codigo_linha}\",\n            timeout=10\n        )\n        pos_json = r_pos.json()\n        pos_list = pos_json.get(\"vs\") if isinstance(pos_json, dict) else []\n\n        # Se a API retornar lista vazia, usar dados fictícios\n        if not paradas:\n            print(\"Nenhuma parada retornada pela API — usando dados de demonstração.\")\n            return demo_paradas, demo_pos\n\n        return paradas, pos_list\n\n    except Exception as e:\n        print(\"Falha ao acessar a API Olho Vivo:\", e)\n        print(\"Utilizando dados de demonstração.\")\n        return demo_paradas, demo_pos\n\n\n# Carrega paradas e veículos (da API ou demo)\nparadas, pos_list = fetch_paradas_pos(codigo_linha=2506)\nprint(f\"Quantidade carregada: {len(paradas)} paradas, {len(pos_list)} veículos.\")\n\n# Função para calcular o ponto médio das coordenadas — usado como centro do mapa\ndef mean_center(points):\n    lat = [p[\"py\"] for p in points]\n    lon = [p[\"px\"] for p in points]\n    return (sum(lat) / len(lat), sum(lon) / len(lon))\n\n# Caso não existam paradas (situação rara), define um centro padrão\ncenter = mean_center(paradas) if paradas else (-23.534564, -46.654302)\n\n# Criação do mapa com Folium\nm = folium.Map(location=center, zoom_start=14)\n\n# Marca cada parada como um marcador simples\nfor p in paradas:\n    folium.Marker(\n        location=[p[\"py\"], p[\"px\"]],\n        popup=f\"{p.get('np')}\\n{p.get('ed','')}\"\n    ).add_to(m)\n\n# Marca veículos da linha usando círculos vermelhos (se existirem)\nfor v in pos_list:\n    try:\n        folium.CircleMarker(\n            location=[v[\"py\"], v[\"px\"]],\n            radius=6,\n            color=\"red\",\n            fill=True,\n            fill_opacity=0.8,\n            popup=f\"Veículo: {v.get('p')}\\nHorário: {v.get('ta')}\"\n        ).add_to(m)\n    except Exception:\n        pass\n\n# Salva o arquivo HTML do mapa\noutput = \"paradas_linha_2506.html\"\nm.save(output)\nprint(f\"Arquivo gerado: {output}\")\n\n# Exibe o mapa diretamente no Quarto\ndisplay(HTML(m._repr_html_()))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nSPTRANS_TOKEN ausente — carregando dados de demonstração.\nQuantidade carregada: 4 paradas, 2 veículos.\nArquivo gerado: paradas_linha_2506.html\n```\n:::\n\n::: {.cell-output .cell-output-display}\n```{=html}\n<div style=\"width:100%;\"><div style=\"position:relative;width:100%;height:0;padding-bottom:60%;\"><span style=\"color:#565656\">Make this Notebook Trusted to load map: File -> Trust Notebook</span><iframe srcdoc=\"&lt;!DOCTYPE html&gt;\n&lt;html&gt;\n&lt;head&gt;\n    \n    &lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html; charset=UTF-8&quot; /&gt;\n    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js&quot;&gt;&lt;/script&gt;\n    &lt;script src=&quot;https://code.jquery.com/jquery-3.7.1.min.js&quot;&gt;&lt;/script&gt;\n    &lt;script src=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js&quot;&gt;&lt;/script&gt;\n    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js&quot;&gt;&lt;/script&gt;\n    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css&quot;/&gt;\n    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css&quot;/&gt;\n    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-glyphicons.css&quot;/&gt;\n    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.min.css&quot;/&gt;\n    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css&quot;/&gt;\n    &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdn.jsdelivr.net/gh/python-visualization/folium/folium/templates/leaflet.awesome.rotate.min.css&quot;/&gt;\n    \n            &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width,\n                initial-scale=1.0, maximum-scale=1.0, user-scalable=no&quot; /&gt;\n            &lt;style&gt;\n                #map_7e6dba561b29f253bf1c42a900b251dc {\n                    position: relative;\n                    width: 100.0%;\n                    height: 100.0%;\n                    left: 0.0%;\n                    top: 0.0%;\n                }\n                .leaflet-container { font-size: 1rem; }\n            &lt;/style&gt;\n\n            &lt;style&gt;html, body {\n                width: 100%;\n                height: 100%;\n                margin: 0;\n                padding: 0;\n            }\n            &lt;/style&gt;\n\n            &lt;style&gt;#map {\n                position:absolute;\n                top:0;\n                bottom:0;\n                right:0;\n                left:0;\n                }\n            &lt;/style&gt;\n\n            &lt;script&gt;\n                L_NO_TOUCH = false;\n                L_DISABLE_3D = false;\n            &lt;/script&gt;\n\n        \n&lt;/head&gt;\n&lt;body&gt;\n    \n    \n            &lt;div class=&quot;folium-map&quot; id=&quot;map_7e6dba561b29f253bf1c42a900b251dc&quot; &gt;&lt;/div&gt;\n        \n&lt;/body&gt;\n&lt;script&gt;\n    \n    \n            var map_7e6dba561b29f253bf1c42a900b251dc = L.map(\n                &quot;map_7e6dba561b29f253bf1c42a900b251dc&quot;,\n                {\n                    center: [-23.53055075, -46.6650365],\n                    crs: L.CRS.EPSG3857,\n                    ...{\n  &quot;zoom&quot;: 14,\n  &quot;zoomControl&quot;: true,\n  &quot;preferCanvas&quot;: false,\n}\n\n                }\n            );\n\n            \n\n        \n    \n            var tile_layer_d6ed0d3215f91e7def27fc085feae3bc = L.tileLayer(\n                &quot;https://tile.openstreetmap.org/{z}/{x}/{y}.png&quot;,\n                {\n  &quot;minZoom&quot;: 0,\n  &quot;maxZoom&quot;: 19,\n  &quot;maxNativeZoom&quot;: 19,\n  &quot;noWrap&quot;: false,\n  &quot;attribution&quot;: &quot;\\u0026copy; \\u003ca href=\\&quot;https://www.openstreetmap.org/copyright\\&quot;\\u003eOpenStreetMap\\u003c/a\\u003e contributors&quot;,\n  &quot;subdomains&quot;: &quot;abc&quot;,\n  &quot;detectRetina&quot;: false,\n  &quot;tms&quot;: false,\n  &quot;opacity&quot;: 1,\n}\n\n            );\n        \n    \n            tile_layer_d6ed0d3215f91e7def27fc085feae3bc.addTo(map_7e6dba561b29f253bf1c42a900b251dc);\n        \n    \n            var marker_ac1c748f40cabad2da5f8f0413b679d5 = L.marker(\n                [-23.534564, -46.654302],\n                {\n}\n            ).addTo(map_7e6dba561b29f253bf1c42a900b251dc);\n        \n    \n        var popup_eac8dc3771f5e151f64b364235a96ade = L.popup({\n  &quot;maxWidth&quot;: &quot;100%&quot;,\n});\n\n        \n            \n                var html_40de497589a2d6f9b1b08d8c14c46938 = $(`&lt;div id=&quot;html_40de497589a2d6f9b1b08d8c14c46938&quot; style=&quot;width: 100.0%; height: 100.0%;&quot;&gt;ANGELICA B/C AV ANGELICA&lt;/div&gt;`)[0];\n                popup_eac8dc3771f5e151f64b364235a96ade.setContent(html_40de497589a2d6f9b1b08d8c14c46938);\n            \n        \n\n        marker_ac1c748f40cabad2da5f8f0413b679d5.bindPopup(popup_eac8dc3771f5e151f64b364235a96ade)\n        ;\n\n        \n    \n    \n            var marker_426d1df1f64e59f4f077905d23fab06f = L.marker(\n                [-23.525799, -46.679251],\n                {\n}\n            ).addTo(map_7e6dba561b29f253bf1c42a900b251dc);\n        \n    \n        var popup_af86e7e8c9d6c7b2ef44331bc3857422 = L.popup({\n  &quot;maxWidth&quot;: &quot;100%&quot;,\n});\n\n        \n            \n                var html_ea41fda7d223701901dee47b64ddfe5b = $(`&lt;div id=&quot;html_ea41fda7d223701901dee47b64ddfe5b&quot; style=&quot;width: 100.0%; height: 100.0%;&quot;&gt;PARADA PALMEIRAS B/C R PADRE ANTONIO TOMAS&lt;/div&gt;`)[0];\n                popup_af86e7e8c9d6c7b2ef44331bc3857422.setContent(html_ea41fda7d223701901dee47b64ddfe5b);\n            \n        \n\n        marker_426d1df1f64e59f4f077905d23fab06f.bindPopup(popup_af86e7e8c9d6c7b2ef44331bc3857422)\n        ;\n\n        \n    \n    \n            var marker_cbff2212aff152010c38a1e8c8d658e8 = L.marker(\n                [-23.526523, -46.673588],\n                {\n}\n            ).addTo(map_7e6dba561b29f253bf1c42a900b251dc);\n        \n    \n        var popup_2ebd0e15cfa98a94b666477afaa65567 = L.popup({\n  &quot;maxWidth&quot;: &quot;100%&quot;,\n});\n\n        \n            \n                var html_ec7058e57f9889aceeeedd14bb6f1664 = $(`&lt;div id=&quot;html_ec7058e57f9889aceeeedd14bb6f1664&quot; style=&quot;width: 100.0%; height: 100.0%;&quot;&gt;ANTARTICA B/C PC SOUSA ARANHA&lt;/div&gt;`)[0];\n                popup_2ebd0e15cfa98a94b666477afaa65567.setContent(html_ec7058e57f9889aceeeedd14bb6f1664);\n            \n        \n\n        marker_cbff2212aff152010c38a1e8c8d658e8.bindPopup(popup_2ebd0e15cfa98a94b666477afaa65567)\n        ;\n\n        \n    \n    \n            var marker_a47fbe046a4ded22c980194f2254aff4 = L.marker(\n                [-23.535317, -46.653005],\n                {\n}\n            ).addTo(map_7e6dba561b29f253bf1c42a900b251dc);\n        \n    \n        var popup_aebce29fb47376d0b419bbb9c5021310 = L.popup({\n  &quot;maxWidth&quot;: &quot;100%&quot;,\n});\n\n        \n            \n                var html_de61d6ac6c0680fa7e0255bc1dcb7f2f = $(`&lt;div id=&quot;html_de61d6ac6c0680fa7e0255bc1dcb7f2f&quot; style=&quot;width: 100.0%; height: 100.0%;&quot;&gt;PARADA D R EXEMPLO&lt;/div&gt;`)[0];\n                popup_aebce29fb47376d0b419bbb9c5021310.setContent(html_de61d6ac6c0680fa7e0255bc1dcb7f2f);\n            \n        \n\n        marker_a47fbe046a4ded22c980194f2254aff4.bindPopup(popup_aebce29fb47376d0b419bbb9c5021310)\n        ;\n\n        \n    \n    \n            var circle_marker_a5bef1671f4b2d60e511f1e9b3e33d58 = L.circleMarker(\n                [-23.53531725, -46.653005],\n                {&quot;bubblingMouseEvents&quot;: true, &quot;color&quot;: &quot;red&quot;, &quot;dashArray&quot;: null, &quot;dashOffset&quot;: null, &quot;fill&quot;: true, &quot;fillColor&quot;: &quot;red&quot;, &quot;fillOpacity&quot;: 0.8, &quot;fillRule&quot;: &quot;evenodd&quot;, &quot;lineCap&quot;: &quot;round&quot;, &quot;lineJoin&quot;: &quot;round&quot;, &quot;opacity&quot;: 1.0, &quot;radius&quot;: 6, &quot;stroke&quot;: true, &quot;weight&quot;: 3}\n            ).addTo(map_7e6dba561b29f253bf1c42a900b251dc);\n        \n    \n        var popup_575e8d5c846323c15e3a78e9f12a1ab9 = L.popup({\n  &quot;maxWidth&quot;: &quot;100%&quot;,\n});\n\n        \n            \n                var html_a6e98674165ef89294953ce12881f09b = $(`&lt;div id=&quot;html_a6e98674165ef89294953ce12881f09b&quot; style=&quot;width: 100.0%; height: 100.0%;&quot;&gt;Veículo: 12783 Horário: 2024-09-27T01:05:47Z&lt;/div&gt;`)[0];\n                popup_575e8d5c846323c15e3a78e9f12a1ab9.setContent(html_a6e98674165ef89294953ce12881f09b);\n            \n        \n\n        circle_marker_a5bef1671f4b2d60e511f1e9b3e33d58.bindPopup(popup_575e8d5c846323c15e3a78e9f12a1ab9)\n        ;\n\n        \n    \n    \n            var circle_marker_8e43dda9f5539f5e90d6c39f6b643675 = L.circleMarker(\n                [-23.547649, -46.6410115],\n                {&quot;bubblingMouseEvents&quot;: true, &quot;color&quot;: &quot;red&quot;, &quot;dashArray&quot;: null, &quot;dashOffset&quot;: null, &quot;fill&quot;: true, &quot;fillColor&quot;: &quot;red&quot;, &quot;fillOpacity&quot;: 0.8, &quot;fillRule&quot;: &quot;evenodd&quot;, &quot;lineCap&quot;: &quot;round&quot;, &quot;lineJoin&quot;: &quot;round&quot;, &quot;opacity&quot;: 1.0, &quot;radius&quot;: 6, &quot;stroke&quot;: true, &quot;weight&quot;: 3}\n            ).addTo(map_7e6dba561b29f253bf1c42a900b251dc);\n        \n    \n        var popup_45eedaa173e65bf1c3400057411e0a4b = L.popup({\n  &quot;maxWidth&quot;: &quot;100%&quot;,\n});\n\n        \n            \n                var html_00440920dddbf4b0dc67c93b0e8651ec = $(`&lt;div id=&quot;html_00440920dddbf4b0dc67c93b0e8651ec&quot; style=&quot;width: 100.0%; height: 100.0%;&quot;&gt;Veículo: 12534 Horário: 2024-09-27T01:06:10Z&lt;/div&gt;`)[0];\n                popup_45eedaa173e65bf1c3400057411e0a4b.setContent(html_00440920dddbf4b0dc67c93b0e8651ec);\n            \n        \n\n        circle_marker_8e43dda9f5539f5e90d6c39f6b643675.bindPopup(popup_45eedaa173e65bf1c3400057411e0a4b)\n        ;\n\n        \n    \n    \n            tile_layer_d6ed0d3215f91e7def27fc085feae3bc.addTo(map_7e6dba561b29f253bf1c42a900b251dc);\n        \n&lt;/script&gt;\n&lt;/html&gt;\" style=\"position:absolute;width:100%;height:100%;left:0;top:0;border:none !important;\" allowfullscreen webkitallowfullscreen mozallowfullscreen></iframe></div></div>\n```\n:::\n:::\n\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js\" integrity=\"sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js\" integrity=\"sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}